services:
  trend-radar:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: Trend-Radar-Dev
    restart: always
    networks:
      - trendradar
      - resources
    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      # 挂载 crawl_server 目录以支持代码热更新
      - ../crawl_server:/app/crawl_server

    environment:
      - TZ=Asia/Shanghai
      # 核心配置
      - ENABLE_CRAWLER=${ENABLE_CRAWLER:-}
      - ENABLE_NOTIFICATION=${ENABLE_NOTIFICATION:-}
      - REPORT_MODE=${REPORT_MODE:-}
      - SORT_BY_POSITION_FIRST=${SORT_BY_POSITION_FIRST:-}
      - MAX_NEWS_PER_KEYWORD=${MAX_NEWS_PER_KEYWORD:-}
      - REQUEST_INTERVAL=${REQUEST_INTERVAL:-}
      - RANK_THRESHOLD=${RANK_THRESHOLD:-}
      - USE_PROXY=${USE_PROXY:-}
      - DEFAULT_PROXY=${DEFAULT_PROXY:-}
      - VERSION_CHECK_URL=${VERSION_CHECK_URL:-}
      - SHOW_VERSION_UPDATE=${SHOW_VERSION_UPDATE:-}
      # 推送时间窗口
      - PUSH_WINDOW_ENABLED=${PUSH_WINDOW_ENABLED:-}
      - PUSH_WINDOW_START=${PUSH_WINDOW_START:-}
      - PUSH_WINDOW_END=${PUSH_WINDOW_END:-}
      - PUSH_WINDOW_ONCE_PER_DAY=${PUSH_WINDOW_ONCE_PER_DAY:-}
      - PUSH_WINDOW_RETENTION_DAYS=${PUSH_WINDOW_RETENTION_DAYS:-}
      # 通知渠道
      - FEISHU_WEBHOOK_URL=${FEISHU_WEBHOOK_URL:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DINGTALK_WEBHOOK_URL=${DINGTALK_WEBHOOK_URL:-}
      - WEWORK_WEBHOOK_URL=${WEWORK_WEBHOOK_URL:-}
      - WEWORK_MSG_TYPE=${WEWORK_MSG_TYPE:-}
      # 邮件配置
      - EMAIL_FROM=${EMAIL_FROM:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_TO=${EMAIL_TO:-}
      - EMAIL_SMTP_SERVER=${EMAIL_SMTP_SERVER:-}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-}
      # ntfy配置
      - NTFY_SERVER_URL=${NTFY_SERVER_URL:-https://ntfy.sh}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - NTFY_TOKEN=${NTFY_TOKEN:-}
      # Bark配置
      - BARK_URL=${BARK_URL:-}
      # Slack配置
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # Kafka配置
      - KAFKA_ENABLED=${KAFKA_ENABLED}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS}
      - KAFKA_EVENT_TOPIC=${KAFKA_EVENT_TOPIC}
      - KAFKA_EVENT_POISON_TOPIC=${KAFKA_EVENT_POISON_TOPIC}
      - KAFKA_CONSUMER_GROUP_ID=${KAFKA_CONSUMER_GROUP_ID}
      # PostgreSQL配置
      - POSTGRESQL_ENABLED=${POSTGRESQL_ENABLED}
      - POSTGRESQL_HOST=${POSTGRESQL_HOST}
      - POSTGRESQL_PORT=${POSTGRESQL_PORT}
      - POSTGRESQL_DATABASE=${POSTGRESQL_DATABASE}
      - POSTGRESQL_USER=${POSTGRESQL_USER}
      - POSTGRESQL_PASSWORD=${POSTGRESQL_PASSWORD}
      # Redis配置
      - REDIS_ENABLED=${REDIS_ENABLED}
      - REDIS_HOST=${REDIS_HOST}
      - REDIS_PORT=${REDIS_PORT}
      - REDIS_DB=${REDIS_DB}
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      # 定时任务配置（分钟数）
      - SCHEDULE_MINUTES=${SCHEDULE_MINUTES}
      # 消息批处理配置
      - MESSAGE_BATCH_SIZE=${MESSAGE_BATCH_SIZE:-}
      - DINGTALK_BATCH_SIZE=${DINGTALK_BATCH_SIZE:-}
      - FEISHU_BATCH_SIZE=${FEISHU_BATCH_SIZE:-}
      - BARK_BATCH_SIZE=${BARK_BATCH_SIZE:-}
      - BATCH_SEND_INTERVAL=${BATCH_SEND_INTERVAL:-}
      - FEISHU_MESSAGE_SEPARATOR=${FEISHU_MESSAGE_SEPARATOR:-}
      # 权重配置
      - RANK_WEIGHT=${RANK_WEIGHT:-}
      - FREQUENCY_WEIGHT=${FREQUENCY_WEIGHT:-}
      - HOTNESS_WEIGHT=${HOTNESS_WEIGHT:-}
      # 开发模式
      - DEBUG=true

    develop:
      watch:
        # 监听 Python 代码变化，同步文件（不重启容器）
        - action: sync
          path: ../fetch_server
          target: /app/fetch_server
          ignore:
            - __pycache__/
            - *.pyc
            - .git/
        
        # 监听模板文件变化，同步文件（不重启容器）
        - action: sync
          path: ../fetch_server/utils/templates
          target: /app/fetch_server/utils/templates
          ignore:
            - .git/
        
        # 监听配置文件变化，同步文件（不重启容器）
        - action: sync
          path: ../config
          target: /app/config
          ignore:
            - .git/

  trend-mcp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mcp
    container_name: Trend-Radar-MCP-Dev
    restart: always
    networks:
      - trendradar
      - resources
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      # 开发模式：挂载代码目录以支持热更新
      - ../mcp_server:/app/mcp_server
      - ../fetch_server:/app/fetch_server

    ports:
      - "10200:10200"

    environment:
      - TZ=Asia/Shanghai
      - PROJECT_ROOT=/app
      - DEBUG=true

    develop:
      watch:
        # 监听 MCP 服务器代码变化，重启服务
        - action: rebuild
          path: ../mcp_server
          ignore:
            - __pycache__/
            - *.pyc
            - .git/
        
        # 监听 fetch_server 代码变化，同步文件
        - action: sync
          path: ../fetch_server
          target: /app/fetch_server
          ignore:
            - __pycache__/
            - *.pyc
            - .git/
        
        # 监听配置文件变化，同步文件
        - action: sync
          path: ../config
          target: /app/config
          ignore:
            - .git/

  trend-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    container_name: Trend-Radar-Web-Dev
    restart: always
    networks:
      - trendradar
      - resources
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      # 开发模式：挂载代码目录以支持热更新
      - ../web_server:/app/web_server

    ports:
      - "10199:10199"

    environment:
      - TZ=Asia/Shanghai
      - PROJECT_ROOT=/app
      - HOST=0.0.0.0
      - PORT=10199
      - DEBUG=true

    develop:
      watch:
        # 监听 Web 服务器代码变化，重启服务
        - action: rebuild
          path: ../web_server
          ignore:
            - __pycache__/
            - *.pyc
            - .git/
        
        # 监听配置文件变化，同步文件
        - action: sync
          path: ../config
          target: /app/config
          ignore:
            - .git/

networks:
  trendradar:
    driver: bridge
    enable_ipv6: false
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
  resources:
    external: true
