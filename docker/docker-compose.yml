services:
  trend-radar:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: Trend-Radar
    restart: always
    networks:
      - trendradar
      - resources
    dns:
      - 1.1.1.1
      - 8.8.8.8
    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
      # 挂载 fetch_server 目录以支持代码和模板文件热更新（修改代码/模板无需重启容器）
      - ../fetch_server:/app/fetch_server
    environment:
      - TZ=Asia/Shanghai
      # 核心配置
      - ENABLE_CRAWLER=${ENABLE_CRAWLER:-}
      - ENABLE_NOTIFICATION=${ENABLE_NOTIFICATION:-}
      - REPORT_MODE=${REPORT_MODE:-}
      - SORT_BY_POSITION_FIRST=${SORT_BY_POSITION_FIRST:-}
      - MAX_NEWS_PER_KEYWORD=${MAX_NEWS_PER_KEYWORD:-}
      # 推送时间窗口
      - PUSH_WINDOW_ENABLED=${PUSH_WINDOW_ENABLED:-}
      - PUSH_WINDOW_START=${PUSH_WINDOW_START:-}
      - PUSH_WINDOW_END=${PUSH_WINDOW_END:-}
      - PUSH_WINDOW_ONCE_PER_DAY=${PUSH_WINDOW_ONCE_PER_DAY:-}
      - PUSH_WINDOW_RETENTION_DAYS=${PUSH_WINDOW_RETENTION_DAYS:-}
      # 通知渠道
      - FEISHU_WEBHOOK_URL=${FEISHU_WEBHOOK_URL:-}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID:-}
      - DINGTALK_WEBHOOK_URL=${DINGTALK_WEBHOOK_URL:-}
      - WEWORK_WEBHOOK_URL=${WEWORK_WEBHOOK_URL:-}
      - WEWORK_MSG_TYPE=${WEWORK_MSG_TYPE:-}
      # 邮件配置
      - EMAIL_FROM=${EMAIL_FROM:-}
      - EMAIL_PASSWORD=${EMAIL_PASSWORD:-}
      - EMAIL_TO=${EMAIL_TO:-}
      - EMAIL_SMTP_SERVER=${EMAIL_SMTP_SERVER:-}
      - EMAIL_SMTP_PORT=${EMAIL_SMTP_PORT:-}
      # ntfy配置
      - NTFY_SERVER_URL=${NTFY_SERVER_URL:-https://ntfy.sh}
      - NTFY_TOPIC=${NTFY_TOPIC:-}
      - NTFY_TOKEN=${NTFY_TOKEN:-}
      # Bark配置
      - BARK_URL=${BARK_URL:-}
      # Slack配置
      - SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL:-}
      # Kafka配置
      # KAFKA_ENABLED: 是否启用 Kafka（true/false），启用后每次抓取数据会自动发送到 Kafka
      # KAFKA_BOOTSTRAP_SERVERS: Kafka 服务器地址
      #   - Docker 内部（推荐）: Resources-Kafka:9092 (需要加入 resources 网络)
      #   - 宿主机外部: localhost:10109 或实际 IP:10109
      # KAFKA_TOPIC: Kafka topic 名称，默认为 trendradar.fetchdata
      - KAFKA_ENABLED=${KAFKA_ENABLED:-}
      - KAFKA_BOOTSTRAP_SERVERS=${KAFKA_BOOTSTRAP_SERVERS:-}
      - KAFKA_TOPIC=${KAFKA_TOPIC:-}
      # 运行模式
      - CRON_SCHEDULE=${CRON_SCHEDULE:-*/5 * * * *}
      - RUN_MODE=${RUN_MODE:-cron}
      - IMMEDIATE_RUN=${IMMEDIATE_RUN:-true}

  trend-mcp:
    build:
      context: ..
      dockerfile: docker/Dockerfile.mcp
    container_name: Trend-Radar-MCP
    restart: always
    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
    ports:
      - "10200:10200"
    environment:
      - TZ=Asia/Shanghai
      - PROJECT_ROOT=/app
    networks:
      - trendradar
      - resources
    dns:
      - 1.1.1.1
      - 8.8.8.8

  trend-web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    container_name: Trend-Radar-Web
    restart: always
    volumes:
      - ../config:/app/config:ro
      - ../output:/app/output
    ports:
      - "10199:10199"
    environment:
      - TZ=Asia/Shanghai
      - PROJECT_ROOT=/app
      - HOST=0.0.0.0
      - PORT=10199
      - DEBUG=${DEBUG:-false}
    networks:
      - trendradar
      - resources
    dns:
      - 1.1.1.1
      - 8.8.8.8

networks:
  trendradar:
    driver: bridge
    enable_ipv6: false
    driver_opts:
      com.docker.network.bridge.enable_ip_masquerade: "true"
  resources:
    external: true
